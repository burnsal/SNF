---
title: "Readmission Analysis"
author: "Amira Burns"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2: default
  bookdown::word_document2:
    toc: true
  bookdown::pdf_document2:
    keep_tex: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# -- Load Libraries
library(readxl) # read in Excel files
library(car) # Type III Sums of Squares Anova
library(emmeans)  # multiple comparisons
library(tidyverse) # data processing, visualization
library(lubridate) # process dates
library(ggsci) # colors
library(rstatix)
library(gridExtra) # make and arrange tables
library(gtable) 
library(kableExtra)
library(DescTools) # categorical correlation
library(nnet) # multinomial model fitting
library(lme4) # mixed-level model fitting
library(corrr) # tidy correlations
```

```{r load}
snf_data <- read_xlsx("data/SNF_CODED_CALCULATED_SCORES_04042022.xlsx",
                      sheet = "CODED DATA AND CALCULATIONS")

readmits <- read_xlsx("data/Stern 30-day Readmissions 2014 - 2019.xlsx")
```

```{r format_vars}
snf_data <- snf_data %>%
  transmute(SternClientID = `Stern Client Id`,
            MRN = MRN,
            Year = WorkSheet,
            CurrentAdmit = as.Date(`Current Admit`, format = "%m/%d/%y"),          
            DischargeDate = as.Date(`Discharge Date`, format = "%m/%d/%y"),
            Gender = factor(Gender),
            Race = Race,
            Ethnicity = factor(Ethnicity),
            InsurancePlanName = (InsurancePlanName),
            ED6moPrior = factor(`LACE Num_of_ED_visits_prior 6months`),
            PatientAge = PatientAge,
            AdmissionHospital = factor(AdmissionHospital),
            CCIAgeScore = ordered(`CCI AGE SCORE`),
            LACELOSDaysScore = ordered(`LACE LOSDays SCORE`),
            LOSDays = LOSDays,
            LOS5Days = factor(`LOS>=5days`),
            HOSPITALLOS5Days = factor(`HOSPITAL LOS>=5days`),
            VisitType = factor(VisitType),
            AdmitDtm = as.Date(AdmitDtm, format = "%m/%d/%y"),
            DischargeDtm = as.Date(DischargeDtm, format = "%m/%d/%y"),
            NumAdmitPastYear = `NumberOfAdmissionInPastYear`,
            PriorAdmin = ordered(`HOSPITAL # OF admission prior yr`),
            Cancer = factor(`HOSPITAL SCORE D/C ONC SERVICE`),
            AcuteAdmin = factor(`LACE ACUTE ADMISSION`),
            AdminType = factor(`HOSPITAL SCORE INDEX ADMISSION TYPE`),
            Hemoglobin = `Hemoglobin at discharge`,
            HemoglobinLevel = factor(`HOSPITAL SCORE Hemoglobin at discharge`),
            Sodium = `Sodium, Serum at discharge`,
            SodiumLevel = factor(`HOSPITAL SCORE Sodium`),
            LACECCI = `LACE CCI SCORE`,
            MyoInfarc = factor(`Myocardial infarction`),
            CongHrtFail = factor(`Congestive heart failure`),
            PeriphVascDis = factor(`Peripheral vascular disease`),
            CerebroVascDis = factor(`Cerebrovascular disease`),
            Dementia = factor(Dementia),
            ChronPulmoDis = factor(`Chronic pulmonary disease`),
            RheuConTisDis = factor(`Rheumatic disease=connective tissue disease`),
            PepUlcDis = factor(`Peptic ulcer disease`),
            MildLiverDis = factor(`MILD liver disease`), # combine into one liver disease var
            ModSevLiverDis = factor(`MODERATE or SEVERE  liver disease`),
            DiabetesWOChrCom = factor(`Diabetes WITHOUT chronic complication`), # combine into one diabetes var
            DiabetesWChrCom = factor(`Diabetes WITH chronic complication`),
            HemiParaPlegia = factor(`Hemiplegia or paraplegia`),
            RenalDisCKD = factor(`Renal disease = mod to severe CKD`),
            Malignancy = factor(`Any Malignancy`),
            MetaSolidTumor = factor(`Metastatic solid tumour`),
            AidsHIV = factor(`AIDS/HIV`),
            CCI = `CALCULATED CCI SCORE`,
            LACE = `CALCULATED LACE SCORE`,
            HOSPITAL = `CALCULATED HOSPITAL SCORE`,
            Readmit30 = `READMISSION <30DAYS`) %>%
  mutate(StayDurationDays = as.numeric((DischargeDate - CurrentAdmit)),
         DtmDuration = DischargeDtm - AdmitDtm)
```  

  
```{r standardize}
# Exclude records before 2014 due to reporting changes
snf_data <- snf_data %>% filter(Year > 2013)

# Create new column for whether or not record is a readmission
snf_data <- snf_data %>%
  mutate(Readmit30 = ifelse(Readmit30 == "N/A", "O", Readmit30)) %>%
  rename(Readmit = Readmit30)


# Standardize values of Race, Insurance, Liver Disease, Diabetes
snf_data <- snf_data %>%
  mutate(Race = as.factor(ifelse(Race == "White", "Caucasian/White",
                       ifelse((Race == "Declined" | Race == "Not Specified" | Race == "Unknown"), "Unavailable/Unknown",
                              ifelse(Race == "Multiracial", "Other/Multiracial", Race)))),
         InsurancePlanCleaned = ifelse(grepl("MEDICARE", InsurancePlanName), "MCARE_MCAID",
                                       ifelse(grepl("MCARE", InsurancePlanName), "MCARE_MCAID",
                                              ifelse(grepl("MEDICAID", InsurancePlanName), "MCARE_MCAID",
                                                     ifelse(grepl("MCAID", InsurancePlanName), "MCARE_MCAID",
                                                            "NO_MCARE_MCAID")))),
         LiverDis = ordered(ifelse(ModSevLiverDis == 3, 3,
                                   ifelse(MildLiverDis == 1, 1, 0))),
         Diabetes = ordered(ifelse(DiabetesWChrCom == 2, 2,
                                   ifelse(DiabetesWOChrCom == 1, 1, 0))))

# relevel Readmit factor, combine original admissions with readmissions > 30 days
snf_data <- snf_data %>%
  mutate(Readmit = ifelse(Readmit == "O", "N", Readmit)) %>%
  mutate(Readmit = as.factor(Readmit))

```

```{r, nas}
# Summarize missing values by variable
nas <- map(snf_data, ~sum(is.na(.)))
# nas %>% as_tibble(nas) 

# Look at records with missing values
NAlook <- function(x) rowSums(x) > 0 
NAs <- snf_data %>% filter(NAlook( across( .cols = everything(), .fns = ~ is.na(.x))))

# remove small number of records with NA values
snf_data <- snf_data %>% na.omit()
```  

```{r data_prep}
# Aggregate Race/Ethnicity
snf_data <- snf_data %>%
  mutate(Race_Eth = factor(ifelse(Ethnicity == "Hispanic or Latino", "Hispanic/Latino", as.character(Race))))

snf_data_a <- snf_data %>% 
  filter(Gender != "Unspecified") %>%
  mutate(Race_Eth = fct_recode(Race_Eth, "Other/Multiracial" = "Native Amer/Alaskan"),
         Insurance = as.factor(InsurancePlanCleaned))
snf_data_a$Gender <- droplevels(snf_data_a$Gender)



```

```{r join_los}
# join length of stay in snf for readmissions 3to main data
readmits <- readmits %>%
  mutate(SternClientID = as.numeric(`Stern ID #`)) %>%
  rename(LOS_snf = LOS) %>%
  select(c(SternClientID, LOS_snf))

snf_data <- snf_data_a %>%
  left_join(readmits, by = "SternClientID")

```

# Introduction  

  - **Research Question**: Are higher acuity scores associated with greater probability of readmission to hospital from skilled nursing facility within 30 days of initial discharge? Acuity scores considered in this analysis are common clinical scores: CCI, LACE, HOSPITAL.
  - **Alternative Hypothesis** $H_a$: Higher acuity scores are associated with higher probability of readmission.  
  - **Null Hypothesis** $H_0$: Higher acuity scores are not associated with higher probability of readmission.  
  - **Response variable**: binary Y/N if a record was for a readmission to an inpatient facility within 30 days of previous discharge. Three possible values are Original admission, Readmission outside 30 days, and Readmission within 30 days. Because financial penalties are assessed on readmissions within 30 days, the first two categories were combined into a **N** category.  
  - **Observational units**: primary observational variables of interest are the three calculated scores assigned to individuals at each admission. Covariates of interest are:  
    - Year: study period 2014-2019
    - Gender: Male/Female  
    - Race/Ethnicity: groups in the dataset are African American/Black, Asian, Caucasian/White, Hispanic/Latino, Other/Multiracial, and Unavailable/Unknown. Sample sizes were too small for some of these groups for us to include it in this analysis, but we note its association with each of the calculated scores and hvae interest in studying this topic further.  
    - Insurance: Medicare-Medicaid/No Medicare-Medicaid as an indicator of socioeconomic status.  
  
# Methods  
Analyses will be conducted in R. All observations from 2010-2013 were removed from analysis due to changes in reporting calculated scores. An additional 33 records with missing values were excluded from overall analysis. Summary statistics for each calculated score will be reviewed, including: number of readmissions, readmission rate, odds of readmission, and log odds. Covariates will be reviewed for sufficient sample size within each group to include in model-fitting. Exploratory data analysis will also include visualizations of empirical log odds (logits) for each calculated score across all potential covariates.  
Model fitting will begin with logistic regression considering the association of acuity score with readmission risk. Separate models will be fitted for each acuity score, and expand to consider covariates as appropriate. Additional observations may be dropped or aggregated in consideration of sample size and will be noted in each case. Individual models will be assessed through reviewing deviance residuals and conducting a $\chi^2$ goodness-of-fit test. Individual predictors will be assessed with confidence intervals. Models will be compared using Akaike's Information Criteria.  
  
*Note: add a MC simulation if there's enough time!*  


# Exploratory Data Analysis

Our primary research interest is whether or not the probability of readmission is associated with calculated score. We calculate the odds $\frac{p}{1-p}$ empirical log odds $log(\frac{p}{1-p})$ of readmissions associated with each level of each acuity score and visualize the potential associations, where $p$ is the probability that a record is of a readmission within 30 days. Summary tables for CCI, LACE, and HOSPITAL can be found in [Appendix A](#AppendixA): .

```{r readmit_CCI}
readmit_cci <- snf_data_a %>%
  group_by(CCI) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit))
```

```{r readmit_LACE}
readmit_lace <- snf_data_a %>%
  group_by(LACE) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit))
```

```{r readmit_HOS}
readmit_hos <- snf_data_a %>%
  group_by(HOSPITAL) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit))

```

```{r readmit_scores_plot}
# combine dfs together
cci_bind <- readmit_cci %>%
  mutate(Score = rep("CCI")) %>%
  rename(Value = CCI) %>%
  relocate(Score)

lace_bind <- readmit_lace %>%
  mutate(Score = rep("LACE")) %>%
  rename(Value = LACE) %>%
  relocate(Score)

hos_bind <- readmit_hos %>%
  mutate(Score = rep("HOSPITAL")) %>%
  rename(Value = HOSPITAL) %>%
  relocate(Score)

readmit_data <- bind_rows(cci_bind, lace_bind, hos_bind)

# remove -inf rows for plotting
readmit_plot <- readmit_data %>% na_if(-Inf)

# plot empirical logits 
ggplot(readmit_plot, aes(x = Value, y = logit.Readmit, shape = Score, label = Value)) + 
  geom_point(alpha=0.4, size = 3) + 
  geom_text() +  geom_line(alpha=0.3) + 
  theme_minimal() + 
  labs(x = "Acuity Score", y = "Empirical Logit") + 
  facet_wrap(vars(Score)) + 
  ggtitle("Empirical Logits by Acuity Score")
```
  
  
    A linear association between CCI score and empirical logit is not clear, especially considering score values greater than 8. A linear association between HOSPITAL score and empirical logit is quite pronounced; while the linear association between LACE score and empirical logit is also quite strong, we can observe two potential outliers for LACE score values of 3 and 18.  
  
We also want to consider whether or not probability of readmission changes over time, with respect to acuity score. Various plots examining readmission by score over year can be found in [Appendix B](#AppendixB); no interaction between score and year is apparent.  
```{r readmit_yr}
readmit_yr_cci <- snf_data_a %>%
  group_by(CCI, Year) %>%
  rename(Value = CCI) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Score = rep("CCI"))

readmit_yr_lace <- snf_data_a %>%
  group_by(LACE, Year) %>%
  rename(Value = LACE) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Score = rep("LACE"))

readmit_yr_hos <- snf_data_a %>%
  group_by(HOSPITAL, Year) %>%
  rename(Value = HOSPITAL) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Score = rep("HOSPITAL"))

```


We are also interested in the potential effect demographic factors have on the relationship between readmission rate and acuity score. Due to the small sample sizes from considering multiple demographics together, we will disaggregate readmission by each acuity score over one demographic factor (Gender, Race/Ethnicity, Insurance) at a time. Tables and plots for readmission logits by demographic covariates are available in [Appendix C](#AppendixC). Sample sizes among groups for Race/Ethnicity are too small for this factor to be considered in model fitting; however, previous analysis showed strong evidence that Race/Ethnicity was associated with differences in calculated scores while controlling for other factors. Consequently, this factor should be examined in further study of readmission rates.

```{r readmit_cci_demo}
readmit_cci_gen <- snf_data_a %>%
  group_by(CCI, Gender) %>%
  rename(Value = Gender) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Demo = rep("Gender"))

readmit_cci_re <- snf_data_a %>%
  group_by(CCI, Race_Eth) %>%
  rename(Value = Race_Eth) %>% 
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Demo = rep("Race/Ethnicity"))

readmit_cci_ins <- snf_data_a %>%
  group_by(CCI, Insurance) %>%
  rename(Value = Insurance) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Demo = rep("Insurance"))

```

```{r readmit_lace_demo}
readmit_lace_gen <- snf_data_a %>%
  group_by(LACE, Gender) %>%
  rename(Value = Gender) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Demo = rep("Gender"))

readmit_lace_re <- snf_data_a %>%
  group_by(LACE, Race_Eth) %>%
  rename(Value = Race_Eth) %>% 
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Demo = rep("Race/Ethnicity"))

readmit_lace_ins <- snf_data_a %>%
  group_by(LACE, Insurance) %>%
  rename(Value = Insurance) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Demo = rep("Insurance"))


  
```
  
  
```{r readmit_hos_demo}
readmit_hos_gen <- snf_data_a %>%
  group_by(HOSPITAL, Gender) %>%
  rename(Value = Gender) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Demo = rep("Gender"))

readmit_hos_re <- snf_data_a %>%
  group_by(HOSPITAL, Race_Eth) %>%
  rename(Value = Race_Eth) %>% 
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Demo = rep("Race/Ethnicity"))

readmit_hos_ins <- snf_data_a %>%
  group_by(HOSPITAL, Insurance) %>%
  rename(Value = Insurance) %>%
  summarize(meanAge = mean(PatientAge), n=n(), 
            n.Readmit = sum(Readmit == "Y"),
            p.Readmit = sum(Readmit == "Y")/n,
            odds.Readmit = p.Readmit / (1 - p.Readmit),
            logit.Readmit = log(odds.Readmit)) %>%
  mutate(Demo = rep("Insurance"))

```  
  


# Model Fitting

Logistic regression is the appropriate model class for our binary response, where we want to model the probability that a record is for a readmission within 30 days. CCI values ranged 0-15; score values of 16, 17 were excluded due to small sample size (n = 1). LACE values ranged 2-19; no values were excluded. HOSPITAL values ranged 0-11; score values of 12 were excluded due to small sample size (n = 2).
We start model fitting with a basic model for each calculated score.  


```{r cut_df}
readmit_cci_cut <- readmit_cci %>% filter(CCI < 16)
readmit_hos_cut <- readmit_hos %>% filter(HOSPITAL < 12)
```  
  
## CCI 

The base model for readmission against CCI can be written as:  


$$
\begin{aligned}
log(\frac{p_{CCI_i}}{1-p_{CCI_{i}}}) &= \beta_0 + \beta_1  CCI_i \\
p_{CCI_{i}} &= \frac{e^{\beta_0 + \beta_1CCI_{i}}}{1 + e^{\beta_0 + \beta_1CCI_{i}}}
\end{aligned}
$$
where $i\ \epsilon\ [0, 14]$
  


```{r cci_base}
# Fit base model
CCI_mod0 <- glm(cbind(n.Readmit, n-n.Readmit) ~ CCI, family = binomial(link="logit"), data = readmit_cci_cut)

# get ests and confints
cci_b0 <- CCI_mod0$coefficients[1]
cci_b1 <- CCI_mod0$coefficients[2]
cci_confint <- confint(CCI_mod0)
cci_or <- exp(cci_b1)
cci_or_confint <- exp(cci_confint[2,])
```

The estimated odds ratio for CCI is $e^{\hat{B_1}} = e^{0.003} = 1.003$, 95% CI: (0.98, 1.03); we find no evidence that CCI score is associated with risk for readmission within 30 days. 

The estimated model for probability of readmission can be estimated as:  

$$p_{CCI_i} = \frac{e^{-1.701 + 0.003*CCI_i}}{1+e^{-1.701 + 0.003*CCI_i}}$$
```{r cci_modplot}
x <- seq(0, 15, 0.1)
y <- exp(cci_b0 + cci_b1*x) / (1 + (exp(cci_b0 + cci_b1*x)))
cci_modline <- data.frame(x, y)

cci_fits <- data.frame(CCI = seq(0, 15, 1),
                       fit = fitted(CCI_mod0))

cci_rawdat <- snf_data_a %>%
  select(c(CCI, Readmit)) %>%
  mutate(Readmit = as.numeric(Readmit) - 1) %>%
  filter(CCI < 16)

ggplot(readmit_cci_cut, aes(CCI, p.Readmit)) +
  geom_point(col = 2, alpha = 0.7, size = 3) + 
  geom_point(data = cci_fits, aes(x = CCI, y = fit), col = 4, alpha = 0.7, shape = 15, size = 3) + 
  geom_jitter(data=cci_rawdat, aes(x = CCI, y=Readmit), width=0.1, height=0.05, alpha = 0.5, size = 1) + 
  geom_line(data=cci_modline, aes(x=x, y=y), alpha = 0.5) + 
  ylim(0, 1) + 
  theme_minimal() + 
  labs(x = "CCI Score", y = "Probability of Readmission") + 
  ggtitle("Probability of Readmission by CCI: Raw data + fitted model")

```
  
      
*Note: Add manual legend! The line is the fitted model line, and the blue squares are the fitted values. The red circles are the empirical proportions of readmissions for each value of CCI. The black blobs are the raw data for each record. Maybe remove this last piece, since it doesn't add much to the visual story*  

Full model diagnostics can be reviewed in [Appendix D](#AppendixD). No CCI + covariate models need to be fitted since we find no evidence that changes in CCI score are associated with changes in readmission risk.  
  
  
## LACE  

The base model for readmission against LACE can be written as:  
  
$$
\begin{aligned}
log(\frac{p_{LACE_i}}{1-p_{LACE_{i}}}) &= \beta_0 + \beta_1  LACE_i \\
p_{LACE_{i}} &= \frac{e^{\beta_0 + \beta_1LACE_{i}}}{1 + e^{\beta_0 + \beta_1LACE_{i}}}
\end{aligned}
$$
where $i\ \epsilon\ [2, 19]$  

```{r lace_base}
# Fit base model
lace_mod0 <- glm(cbind(n.Readmit, n-n.Readmit) ~ LACE, 
                 family = binomial(link="logit"), data = readmit_lace)

# refit without LACE=11 see Appendix E diags
readmit_lace_cut <- readmit_lace %>%
  filter(LACE != 12)

lace_mod1 <- glm(cbind(n.Readmit, n-n.Readmit) ~ LACE, 
                 family = binomial(link="logit"), data = readmit_lace_cut)

# refit with quasibinomial variation; see Appendix E  
lace_mod2 <- glm(cbind(n.Readmit, n-n.Readmit) ~ LACE, 
                 family = quasibinomial, data = readmit_lace)

# get ests and confints
lace_b0 <- lace_mod2$coefficients[1]
lace_b1 <- lace_mod2$coefficients[2]
lace_confint <- confint(lace_mod2)
lace_or <- exp(lace_b1)
lace_or_confint <- exp(lace_confint[2,])
```

The estimated odds ratio for LACE is $e^{\hat{B_1}} = e^{0.155} = 1.167$, 95% CI: (1.117, 1.221); these results provide evidence that odds of readmission increases 11.7% - 22.1% for each increased value in LACE score. The confidence intervals given are calculated with an quasibinomial overdispersion parameter $\phi = 4.26$ to account for extra-binomial variation present in the data. See [Appendix E](#AppendixE) for full model diagnostics.

The estimated model for probability of readmission can be estimated as:  

$$p_{LACE_i} = \frac{e^{-3.521 + 0.155*LACE_i}}{1+e^{-3.521 + 0.155*LACE_i}}$$

*Note: need to plot base model, fit models with covariates, and perform model selection*  
  
## HOSPITAL  
  
The base model for readmission against HOSPITAL can be written as:  
  
$$
\begin{aligned}
log(\frac{p_{HOS_i}}{1-p_{HOS_{i}}}) &= \beta_0 + \beta_1  HOS_i \\
p_{HOS_{i}} &= \frac{e^{\beta_0 + \beta_1HOS_{i}}}{1 + e^{\beta_0 + \beta_1HOS_{i}}}
\end{aligned}
$$  
where $i\ \epsilon\ [0, 11]$  

```{r hos_base}
# fit base model
hos_mod0 <- glm(cbind(n.Readmit, n-n.Readmit) ~ HOSPITAL, family=
                  binomial(link="logit"), data = readmit_hos_cut)

# get ests and confints
hos_b0 <- hos_mod0$coefficients[1]
hos_b1 <- hos_mod0$coefficients[2]
hos_confint <- confint(hos_mod0)
hos_or <- exp(hos_b1)
hos_or_confint <- exp(hos_confint[2,])

```
  
The estimated odds ratio readmission risk for HOSPITAL is $e^{\hat{B_1}} = e^{0.251} = 1.285$, 95% CI: (1.253, 1.318); these results provide evidence that odds of readmission increases between 25.3% - 31.8% for each increased value in HOSPITAL score.  
  
The estimated model for probability of readmission can be estimated as:  

$$p_{HOSP_i} = \frac{e^{-2.708 + 0.251*HOSP_i}}{1+e^{-2.708 + 0.251*HOSP_i}}$$  
  
Full model diagnostics are available in [Appendix F](#AppendixF)  
  
*Note need to plot base model, fit models with covariates, and perform model selection*    
  
  
## Additional Model Fitting  
  - Explore patterns within the <30 day readmissions for changes in scores. Model LOS against acuity scores

# Discussion and Conclusions  
  
*Note: will add more based on discussion and additional model fitting*  
  
  - Goodness-of-fit tests indicate that none of the base models are good fits to the data. This may indicate: 
    + a lack of relationship between acuity score and probability of readmission  
    + the need to introduce covariates into the models. These covariates may be those already identified, or covariates in the dataset not yet considered, or factors not captured in the dataset
    + the need to pursue alternative methods to confirm these results. MC simulations would be my next idea.  
  - The conclusion may be that readmission rates are holding steady despite changes in acuity scores. What clinical impacts can come from this conclusion?  
  - Is there consideration in this analysis of the ANOVAs previously done to examination associations between calculated scores and demographic factors? If so, how?
  

***

# Appendices

## Appendix A: Summary Statistics Tables {#AppendixA}

```{r appendA}
readmit_cci %>% 
  kbl(caption = "Readmission Empirical Statistics by CCI Score", digits=3,
      col.names = c("CCI Score", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_classic_2(full_width = F)


readmit_lace %>% 
  kbl(caption = "Readmission Empirical Statistics by LACE Score", digits=3,
      col.names = c("LACE Score", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_classic_2(full_width = F)


readmit_hos %>% 
  kbl(caption = "Readmission Empirical Statistics by HOSPITAL Score", digits=3,
      col.names = c("HOS Score", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_classic_2(full_width = F)
```
  
## Appendix B: Plots of Empirical Logits by Year, Score {#AppendixB}
```{r appendB}
readmit_yr <- bind_rows(readmit_yr_cci, readmit_yr_lace, readmit_yr_hos) 

readmit_plot <- readmit_yr %>% na_if(-Inf)
ggplot(readmit_plot, aes(x = Value, y = logit.Readmit, shape = Score)) + 
  geom_point(alpha = 0.4, size = 3) + geom_line() + 
  facet_wrap(vars(Year)) + 
  theme_minimal() + 
  labs(x = "Acuity Score", y = "Empirical Logit", shape = "Score") + 
  ggtitle("Empirical Logit by Calculated Score, Year")

yr_cci_plot <- readmit_yr_cci %>% na_if(-Inf)
ggplot(yr_cci_plot, aes(x = Value, y = logit.Readmit, col= as.factor(Year))) + 
  geom_point(alpha = 0.4, size = 3) + geom_line() + 
  theme_minimal() + 
  labs(x = "CCI Score", y = "Empirical Logit", col = "Year") + 
  ggtitle("Empirical Logit by CCI Score, Year")

yr_lace_plot <- readmit_yr_lace %>% na_if(-Inf)
ggplot(yr_lace_plot, aes(x = Value, y = logit.Readmit, col= as.factor(Year))) + 
  geom_point(alpha = 0.4, size = 3) + geom_line() + 
  theme_minimal() + 
  labs(x = "LACE Score", y = "Empirical Logit", col = "Year") + 
  ggtitle("Empirical Logit by LACE Score, Year")

yr_hos_plot <- readmit_yr_hos %>% na_if(-Inf)
ggplot(yr_hos_plot, aes(x = Value, y = logit.Readmit, col= as.factor(Year))) + 
  geom_point(alpha = 0.4, size = 3) + geom_line() + 
  theme_minimal() + 
  labs(x = "HOSP Score", y = "Empirical Logit", col = "Year") + 
  ggtitle("Empirical Logit by HOSPITAL Score, Year")
```
  
## Appendix C: Demographic EDA Tables, Plots {#AppendixC}  
```{r appendc_cci}
readmit_cci_gen %>% 
  select(!Demo) %>%
  kbl(caption = "Readmission Empirical Statistics by CCI Score, Gender", digits=3,
      col.names = c("CCI Score", "Gender", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_minimal(full_width = F) %>%
  column_spec(1, bold=T)

readmit_cci_re %>% 
  select(!Demo) %>%
  kbl(caption = "Readmission Empirical Statistics by CCI Score, Race/Ethnicity", digits=3,
      col.names = c("CCI Score", "Race/Ethnicity", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_minimal(full_width = F) %>%
  column_spec(1, bold=T) 

readmit_cci_ins %>% 
  select(!Demo) %>%
  kbl(caption = "Readmission Empirical Statistics by CCI Score, Insurance", digits=3,
      col.names = c("CCI Score", "Insurance", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_minimal(full_width = F) %>%
  column_spec(1, bold=T) 

cci_gen_plot <- readmit_cci_gen %>% na_if(-Inf)
ggplot(cci_gen_plot, aes(x = CCI, y=logit.Readmit, shape=Value, label=CCI)) + 
  geom_point(alpha = 0.3, size = 5) + geom_line(alpha = 0.3) +
  geom_text() + 
  labs(x = "CCI Score", y = "Empirical Logit", shape = "Gender") + 
  theme_minimal() + ggtitle("Empirical Logit by CCI Score, Gender")

cci_re_plot <- readmit_cci_re %>% na_if(-Inf)
ggplot(cci_re_plot, aes(x = CCI, y=logit.Readmit, shape=Value, label=CCI)) + 
  geom_point(alpha = 0.3, size = 5) + geom_line(alpha = 0.3) + 
  geom_text() + 
  labs(x = "CCI Score", y = "Empirical Logit", shape = "Race/Ethnicity") + 
  theme_minimal() + ggtitle("Empirical Logit by CCI Score, Race/Ethnicity")

cci_ins_plot <- readmit_cci_ins %>% na_if(-Inf)
ggplot(cci_ins_plot, aes(x = CCI, y=logit.Readmit, shape=Value, label=CCI)) + 
  geom_point(alpha = 0.3, size = 5) + geom_line(alpha = 0.3) + 
  geom_text() + 
  labs(x = "CCI Score", y = "Empirical Logit", shape = "Insurance") + 
  theme_minimal() + ggtitle("Empirical Logit by CCI Score, Insurance")
```

```{r appendc_lace}
readmit_lace_gen %>% 
  select(!Demo) %>%
  kbl(caption = "Readmission Empirical Statistics by LACE Score, Gender", digits=3,
      col.names = c("LACE Score", "Gender", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_minimal(full_width = F) %>%
  column_spec(1, bold=T) 

readmit_lace_re %>% 
  select(!Demo) %>%
  kbl(caption = "Readmission Empirical Statistics by LACE Score, Race/Ethnicity", digits=3,
      col.names = c("LACE Score", "Race/Ethnicity", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_minimal(full_width = F) %>%
  column_spec(1, bold=T) 

readmit_lace_ins %>% 
  select(!Demo) %>%
  kbl(caption = "Readmission Empirical Statistics by LACE Score, Insurance", digits=3,
      col.names = c("LACE Score", "Insurance", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_minimal(full_width = F) %>%
  column_spec(1, bold=T) 


lace_gen_plot <- readmit_lace_gen %>% na_if(-Inf)
ggplot(lace_gen_plot, aes(x = LACE, y=logit.Readmit, shape=Value, label=LACE)) + 
  geom_point(alpha = 0.3, size = 5) + geom_line(alpha = 0.3) +
  geom_text() + 
  labs(x = "LACE Score", y = "Empirical Logit", shape = "Gender") + 
  theme_minimal() + ggtitle("Empirical Logit by LACE Score, Gender")

lace_re_plot <- readmit_lace_re %>% na_if(-Inf)
ggplot(lace_re_plot, aes(x = LACE, y=logit.Readmit, shape=Value, label=LACE)) + 
  geom_point(alpha = 0.3, size = 5) + geom_line(alpha = 0.3) + 
  geom_text() + 
  labs(x = "LACE Score", y = "Empirical Logit", shape = "Race/Ethnicity") + 
  theme_minimal() + ggtitle("Empirical Logit by LACE Score, Race/Ethnicity")

lace_ins_plot <- readmit_lace_ins %>% na_if(-Inf)
ggplot(lace_ins_plot, aes(x = LACE, y=logit.Readmit, shape=Value, label=LACE)) + 
  geom_point(alpha = 0.3, size = 5) + geom_line(alpha = 0.3) + 
  geom_text() + 
  labs(x = "LACE Score", y = "Empirical Logit", shape = "Insurance") + 
  theme_minimal() + ggtitle("Empirical Logit by LACE Score, Insurance")
```


```{r appendc_hos}
readmit_hos_gen %>% 
  select(!Demo) %>%
  kbl(caption = "Readmission Empirical Statistics by HOSPITAL Score, Gender", digits=3,
      col.names = c("HOSP Score", "Gender", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_minimal(full_width = F) %>%
  column_spec(1, bold=T) 

readmit_hos_re %>% 
  select(!Demo) %>%
  kbl(caption = "Readmission Empirical Statistics by HOSPITAL Score, Race/Ethnicity", digits=3,
      col.names = c("HOSP Score", "Race/Ethnicity", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_minimal(full_width = F) %>%
  column_spec(1, bold=T) 

readmit_hos_ins %>% 
  select(!Demo) %>%
  kbl(caption = "Readmission Empirical Statistics by HOSPITAL Score, Insurance", digits=3,
      col.names = c("HOSP Score", "Insurance", "Mean Age", "N", "Readmit No.", "Readmit Prop", "Readmit Odds", "Readmit Logit")) %>%
  kable_minimal(full_width = F) %>%
  column_spec(1, bold=T)

hos_gen_plot <- readmit_hos_gen %>% na_if(-Inf)
ggplot(hos_gen_plot, aes(x = HOSPITAL, y=logit.Readmit, shape=Value, label=HOSPITAL)) + 
  geom_point(alpha = 0.3, size = 5) + geom_line(alpha = 0.3) +
  geom_text() + 
  labs(x = "HOSP Score", y = "Empirical Logit", shape = "Gender") + 
  theme_minimal() + ggtitle("Empirical Logit by HOSPITAL Score, Gender")

hos_re_plot <- readmit_hos_re %>% na_if(-Inf)
ggplot(hos_re_plot, aes(x = HOSPITAL, y=logit.Readmit, shape=Value, label=HOSPITAL)) + 
  geom_point(alpha = 0.3, size = 5) + geom_line(alpha = 0.3) + 
  geom_text() + 
  labs(x = "HOSP Score", y = "Empirical Logit", shape = "Race/Ethnicity") + 
  theme_minimal() + ggtitle("Empirical Logit by HOSPITAL Score, Race/Ethnicity")

hos_ins_plot <- readmit_hos_ins %>% na_if(-Inf)
ggplot(hos_ins_plot, aes(x = HOSPITAL, y=logit.Readmit, shape=Value, label=HOSPITAL)) + 
  geom_point(alpha = 0.3, size = 5) + geom_line(alpha = 0.3) + 
  geom_text() + 
  labs(x = "HOSP Score", y = "Empirical Logit", shape = "Insurance") + 
  theme_minimal() + ggtitle("Empirical Logit by HOSPITAL Score, Insurance")
```


## Appendix D: CCI Model Residual Diagnostics {#AppendixD}

Base CCI model: $log(\frac{p}{1-p}) = b_0 + b_1*CCI$ :  
```{r base_cci_diag}
summary(CCI_mod0)

CCI_mod0_plots <- data.frame(CCI = seq(0, 15, 1),
                             Resids = resid(CCI_mod0, type = "deviance"),
                             Fits = fitted(CCI_mod0))

ggplot(CCI_mod0_plots, aes(x = Fits, y = Resids, label = CCI)) + 
  geom_point(size = 3, alpha = 0.3) + geom_text(fontface = "bold") + 
  theme_minimal() + 
  ggtitle("Deviance Residuals by Fitted Values")

# Goodness-of-Fit Test
cci_modfit <- pchisq(CCI_mod0$deviance, df=14, lower.tail = FALSE)
```

The results of the $\chi^2_{14}$ goodness-of-fit test (p = `r round(cci_modfit, 3)`) indicate significant evidence of lack of fit. This is likely due to the larger residuals for CCI values 13-14; could refit the model excluding this data which will result in better model fit, but it will not change the practical conclusion reached regarding the association between CCI score and risk of readmission.  

  
## Appendix E: LACE Model Residual Diagnostics {#AppendixE}
```{r base_lace_diag}
# Base model with full data
summary(lace_mod0)

lace_mod0_plots <- data.frame(LACE = seq(2, 19, 1),
                             Resids = resid(lace_mod0, type = "deviance"),
                             Fits = fitted(lace_mod0))

ggplot(lace_mod0_plots, aes(x = Fits, y = Resids, label = LACE)) + 
  geom_point(size = 3, alpha = 0.3) + geom_text(fontface = "bold") + 
  theme_minimal() + 
  ggtitle("LACE Mod 0 Deviance Residuals by Fitted Values")

lace_mod0_gof <- pchisq(lace_mod0$deviance, df=16, lower.tail = FALSE)

# Base model without LACE=12
summary(lace_mod1)

lace_mod1_plots <- data.frame(LACE = c(seq(2, 11, 1), seq(13, 19, 1)),
                             Resids = resid(lace_mod1, type = "deviance"),
                             Fits = fitted(lace_mod1))

ggplot(lace_mod1_plots, aes(x = Fits, y = Resids, label = LACE)) + 
  geom_point(size = 3, alpha = 0.3) + geom_text(fontface = "bold") + 
  theme_minimal() + 
  ggtitle("LACE Mod 1 Deviance Residuals by Fitted Values")

lace_mod1_gof <- pchisq(lace_mod1$deviance, df=15, lower.tail = FALSE)

```

Removing the potential outlier does not improve goodness-of-fit, so rather than remove information we can use a quasibinomial distribution to increase the standard errors of the model estimates and account for the additional variation in the data. Model fitting with covariates may also resolve the issue of extra-binomial variation.    


  
## Appendix F: HOSPITAL Model Residual Diagnostics {#AppendixF}  
```{r hos_base_diag}
# base model  
summary(hos_mod0)

hos_mod0_plots <- data.frame(HOS = seq(0, 11, 1),
                             Resids = resid(hos_mod0, type = "deviance"),
                             Fits = fitted(hos_mod0))

ggplot(hos_mod0_plots, aes(x = Fits, y = Resids, label = HOS)) + 
  geom_point(size = 3, alpha = 0.3) + geom_text(fontface = "bold") + 
  theme_minimal() + 
  ggtitle("HOSPITAL Mod 0 Deviance Residuals by Fitted Values")

hos_mod0_gof <- pchisq(hos_mod0$deviance, df=10, lower.tail = FALSE)

```

***




